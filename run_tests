#!/usr/bin/env python3
"""Create a venv (if needed), install test deps, and run pytest.
Cross-platform helper â€” safe to run with `./run_tests` or `python run_tests`.
"""
import os
import subprocess
import sys
import venv

ROOT = os.path.dirname(__file__)
VENV_DIR = os.path.join(ROOT, ".venv")
PY = sys.executable

def ensure_venv():
    if not os.path.isdir(VENV_DIR):
        print("Creating virtualenv...")
        venv.create(VENV_DIR, with_pip=True)
    # path to the venv python
    if sys.platform == "win32":
        return os.path.join(VENV_DIR, "Scripts", "python.exe")
    return os.path.join(VENV_DIR, "bin", "python")

def run(cmd, **kwargs):
    print("$", " ".join(cmd))
    subprocess.check_call(cmd, **kwargs)

def main():
    venv_py = ensure_venv()
    run([venv_py, "-m", "pip", "install", "-q", "pytest"])
    run([venv_py, "-m", "pytest", "-q"], cwd=ROOT)

if __name__ == "__main__":
    try:
        main()
    except subprocess.CalledProcessError as exc:
        print(f"Command failed: {exc}")
        sys.exit(exc.returncode)
