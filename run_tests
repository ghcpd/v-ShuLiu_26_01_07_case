#!/usr/bin/env python3
"""Create a small venv, install test deps and run pytest.

Run this from the project root as `./run_tests`.
"""
import os
import platform
import subprocess
import sys
import venv

ROOT = os.path.dirname(__file__)
VENV_DIR = os.path.join(ROOT, ".venv")

builder = venv.EnvBuilder(with_pip=True)
print("Creating virtual environment in .venv...")
builder.create(VENV_DIR)

if platform.system() == "Windows":
    py = os.path.join(VENV_DIR, "Scripts", "python.exe")
else:
    py = os.path.join(VENV_DIR, "bin", "python")

print("Upgrading pip and installing test requirements (pytest)...")
subprocess.check_call([py, "-m", "pip", "install", "-U", "pip", "pytest", "pytest-asyncio"])

print("Running pytest...")
subprocess.check_call([py, "-m", "pytest", "-q"])